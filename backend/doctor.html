<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DocBox - Doctor</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, sans-serif; background: #f5f5f5; padding: 16px; max-width: 480px; margin: 0 auto; }
    .header { font-size: 20px; font-weight: 600; padding: 12px 0; color: #1a1a1a; }
    .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card h3 { font-size: 16px; margin-bottom: 4px; }
    .card .summary { font-size: 14px; color: #666; margin-bottom: 12px; }
    .card .esi { font-size: 12px; color: #888; margin-bottom: 8px; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-right: 8px; }
    .btn-approve { background: #22c55e; color: white; }
    .btn-dispute { background: #ef4444; color: white; }
    .btn-sign { background: #3b82f6; color: white; margin-top: 12px; }
    .paperwork { background: #fafafa; border: 1px solid #e5e5e5; border-radius: 8px; padding: 16px; margin-top: 12px; white-space: pre-wrap; font-size: 13px; max-height: 400px; overflow-y: auto; }
    .empty { text-align: center; color: #999; padding: 40px; }
    .dispute-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; margin-top: 8px; }
    .discharged { color: #22c55e; font-weight: 600; padding: 12px 0; }
    .loading { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <div class="header">DocBox &mdash; Discharge Notifications</div>
  <div id="inbox"><div class="empty">Waiting for discharge notifications...</div></div>

  <script>
    const API = window.location.origin + '/api';
    const inbox = document.getElementById('inbox');
    const patients = {};

    // WebSocket connection with auto-reconnect
    function connectWS() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'discharge_ready') {
          addNotification(msg);
        }
      };
      ws.onclose = () => setTimeout(connectWS, 2000);
    }
    connectWS();

    function addNotification(msg) {
      if (patients[msg.patient_id]) return;
      patients[msg.patient_id] = msg;

      const emptyEl = inbox.querySelector('.empty');
      if (emptyEl) emptyEl.remove();

      const card = document.createElement('div');
      card.className = 'card';
      card.id = `card-${msg.patient_id}`;
      card.innerHTML = `
        <h3>${escapeHtml(msg.name)}</h3>
        <div class="summary">${escapeHtml(msg.summary)}</div>
        <button class="btn btn-approve" onclick="approve('${msg.patient_id}')">Approve Discharge</button>
        <button class="btn btn-dispute" onclick="showDispute('${msg.patient_id}')">Dispute</button>
        <div id="dispute-${msg.patient_id}" style="display:none">
          <input class="dispute-input" id="reason-${msg.patient_id}" placeholder="What are you waiting for?">
          <button class="btn" style="margin-top:8px;background:#333;color:white" onclick="dispute('${msg.patient_id}')">Submit Dispute</button>
        </div>
        <div id="papers-${msg.patient_id}"></div>
      `;
      inbox.appendChild(card);
    }

    async function approve(pid) {
      const card = document.getElementById(`card-${pid}`);
      card.classList.add('loading');
      try {
        const res = await fetch(`${API}/discharge/${pid}/approve`, { method: 'POST' });
        const data = await res.json();
        const papersDiv = document.getElementById(`papers-${pid}`);
        papersDiv.innerHTML = `
          <div class="paperwork"><strong>SOAP Note:</strong>\n${escapeHtml(data.papers.soap_note)}</div>
          <div class="paperwork"><strong>After Visit Summary:</strong>\n${escapeHtml(data.papers.avs)}</div>
          <div class="paperwork"><strong>Work/School Form:</strong>\n${escapeHtml(JSON.stringify(data.papers.work_school_form, null, 2))}</div>
          <button class="btn btn-sign" onclick="sign('${pid}')">Accept &amp; Sign</button>
        `;
      } finally {
        card.classList.remove('loading');
      }
    }

    function showDispute(pid) {
      document.getElementById(`dispute-${pid}`).style.display = 'block';
    }

    async function dispute(pid) {
      const reason = document.getElementById(`reason-${pid}`).value;
      await fetch(`${API}/discharge/${pid}/dispute`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
      });
      document.getElementById(`card-${pid}`).remove();
      delete patients[pid];
    }

    async function sign(pid) {
      document.getElementById(`card-${pid}`).innerHTML = '<div class="discharged">&#10003; Discharged</div>';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // Load existing pending discharges on page load
    fetch(`${API}/discharge/pending`).then(r => r.json()).then(list => {
      list.forEach(p => addNotification({
        patient_id: p.pid,
        name: p.name,
        summary: p.triage_notes || 'Ready for discharge review'
      }));
    }).catch(() => {});
  </script>
</body>
</html>
